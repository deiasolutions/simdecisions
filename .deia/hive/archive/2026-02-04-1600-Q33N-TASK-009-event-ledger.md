# TASK-009: Event Ledger v1

**Issued by:** Q33N (Dave)
**Date:** 2026-02-04
**Assigned to:** BEE-001
**Priority:** HIGH — gates all Phase 2 work
**Effort:** 8-10 hours

---

## Governing Specs

- **ADR-001-Event-Ledger-Foundation.md** — Schema decisions (14-column table)
- **ADR-002-API-Endpoint-Registry.md** — API endpoints
- **ADR-003-Entity-ID-Convention.md** — Universal entity IDs

---

## Implementation Scope

### 1. Create `runtime/ledger.py`

SQLite table per ADR-001 Decision 1 schema:

```sql
CREATE TABLE events (
    id                  INTEGER PRIMARY KEY AUTOINCREMENT,
    timestamp           TEXT NOT NULL DEFAULT (strftime('%Y-%m-%dT%H:%M:%f','now')),
    event_type          TEXT NOT NULL,
    actor               TEXT NOT NULL,
    target              TEXT,
    domain              TEXT,
    signal_type         TEXT CHECK(signal_type IN ('gravity','light','internal')),
    oracle_tier         INTEGER CHECK(oracle_tier BETWEEN 0 AND 4),
    random_seed         INTEGER,
    completion_promise  TEXT,
    verification_method TEXT,
    payload_json        TEXT,
    cost_tokens         INTEGER,
    cost_usd            REAL,
    cost_carbon         REAL
);
```

Functions:
- `record_event()` — Accept all 14 fields, insert into ledger
- `query_events()` — Filter by event_type, actor, domain, signal_type, time range
- Append-only enforcement (no UPDATE, no DELETE)

### 2. Wire API Endpoints

Per ADR-002:
- `POST /api/events` — Internal event recording
- `GET /api/events` — Query with filters
- `GET /api/events/export?format=json|csv` — Bulk export

### 3. Instrument Existing Code

Record events for:
- Task creation → `task_created` (gravity, domain from intent)
- Task routing → `task_routed` (internal, coding/design/planning)
- Task completion → `task_completed` (gravity)
- Gate checks → `gate_checked` / `gate_passed` (gravity)
- Messages → `message_sent` (light)
- Flights → `flight_started` / `flight_ended` (gravity)

### 4. Tests

- Record and query round-trip
- Filter by each supported dimension
- Export format validation
- Append-only enforcement (no mutation)

---

## Acceptance Criteria

- [x] 14-column schema created per ADR-001
- [x] Universal entity IDs used per ADR-003 (no bare bot_id in ledger)
- [x] Signal types classified for all v1 event types
- [x] Three cost columns present (carbon nullable)
- [~] Every significant system action produces an event (workflow_orchestrator emits; others TBD)
- [x] Events queryable by type, actor, domain, signal_type, time range
- [x] JSON and CSV export functional
- [x] Append-only enforced — no update/delete operations
- [x] All tests pass (16/16)

---

## Constraints

1. **Spec-first** — ADR-001/002/003 are authoritative
2. **Copy, don't import** — Code from deia_raqcoon is copied and refactored
3. **Manual gates** — Dave approves all commits
4. **File-based** — SQLite for indexed data

---

## References

| Document | Location |
|----------|----------|
| ADR-001 | specs/ADR-001-Event-Ledger-Foundation.md |
| ADR-002 | specs/ADR-002-API-Endpoint-Registry.md |
| ADR-003 | specs/ADR-003-Entity-ID-Convention.md |
| TASK-REGISTRY | specs/TASK-REGISTRY.md |

---

**Status:** COMPLETE — Awaiting Q33N approval to archive

*Issued under human sovereignty. All commits require Dave's approval.*
